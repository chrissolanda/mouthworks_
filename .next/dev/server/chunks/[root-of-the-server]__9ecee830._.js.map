{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/laure/im_mouthworks/im_mouthworks/app/api/inventory/create/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\n\r\n// Server-side route to create inventory using the service role key.\r\n// This route verifies the requester's access token and ensures they are a staff/hr user\r\n// before performing the insert with the service role key (bypassing RLS safely).\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // Prefer explicit server config. Fall back to NEXT_PUBLIC_SUPABASE_URL default if present.\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL || \"https://xpybqjfofdmkeiijvwnx.supabase.co\"\r\n\r\n    // Expect the client to forward the user's access token in Authorization header\r\n    const authHeader = req.headers.get(\"authorization\") || \"\"\r\n    const token = authHeader.replace(/^Bearer\\s+/i, \"\")\r\n    if (!token) {\r\n      return NextResponse.json({ error: \"Missing Authorization token\" }, { status: 401 })\r\n    }\r\n\r\n    const body = await req.json()\r\n\r\n    // Service role must be provided in production. Allow a DEV-only fallback to anon key.\r\n    // WARNING: This is insecure and only intended to unblock local development/testing.\r\n    let serverKey = process.env.SUPABASE_SERVICE_ROLE || process.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE\r\n    if (!serverKey) {\r\n      if (process.env.NODE_ENV === \"production\") {\r\n        const hint = \"Set SUPABASE_SERVICE_ROLE env var (use your Supabase project's service_role key).\\nIn PowerShell: $env:SUPABASE_SERVICE_ROLE='your-key'\"\r\n        return NextResponse.json({ error: `Missing SUPABASE_SERVICE_ROLE. ${hint}` }, { status: 500 })\r\n      } else {\r\n        serverKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n        console.warn(\r\n          \"[v0] SUPABASE_SERVICE_ROLE not set â€” falling back to NEXT_PUBLIC_SUPABASE_ANON_KEY for local development (insecure).\"\r\n        )\r\n      }\r\n    }\r\n\r\n    if (!serverKey) {\r\n      const hint =\r\n        \"Set SUPABASE_SERVICE_ROLE env var (use your Supabase project's service_role key).\\nIn PowerShell: $env:SUPABASE_SERVICE_ROLE='your-key'\"\r\n      return NextResponse.json({ error: `Missing SUPABASE_SERVICE_ROLE. ${hint}` }, { status: 500 })\r\n    }\r\n\r\n    const supabase = createServerClient(supabaseUrl, serverKey, {\r\n      global: {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      },\r\n    })\r\n\r\n    // Verify token and fetch the user\r\n    const { data: userRes, error: userErr } = await supabase.auth.getUser()\r\n    if (userErr || !userRes?.user) {\r\n      return NextResponse.json({ error: \"Invalid or expired token\" }, { status: 401 })\r\n    }\r\n\r\n    const userId = userRes.user.id\r\n\r\n    // Check staff table to ensure the caller is allowed to add inventory\r\n    const { data: staffRow, error: staffErr } = await supabase\r\n      .from(\"staff\")\r\n      .select(\"id, role, user_id\")\r\n      .eq(\"user_id\", userId)\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    if (staffErr) {\r\n      return NextResponse.json({ error: staffErr.message || String(staffErr) }, { status: 500 })\r\n    }\r\n\r\n    if (!staffRow || (staffRow.role && staffRow.role !== \"hr\" && staffRow.role !== \"staff\")) {\r\n      return NextResponse.json({ error: \"Forbidden: not a staff member\" }, { status: 403 })\r\n    }\r\n\r\n    // simple snake_case conversion for known fields\r\n    const payload: any = {}\r\n    Object.entries(body || {}).forEach(([k, v]) => {\r\n      const snake = k.replace(/[A-Z]/g, (m) => `_${m.toLowerCase()}`)\r\n      payload[snake] = v\r\n    })\r\n\r\n    // Ensure required defaults\r\n    if (typeof payload.quantity === \"undefined\") payload.quantity = 0\r\n    if (typeof payload.min_quantity === \"undefined\") payload.min_quantity = 0\r\n    if (!payload.status) payload.status = \"ok\"\r\n\r\n    const { data, error } = await supabase.from(\"inventory\").insert([payload]).select().single()\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message || String(error) }, { status: 500 })\r\n    }\r\n\r\n    return NextResponse.json(data)\r\n  } catch (err) {\r\n    const msg = err instanceof Error ? err.message : String(err)\r\n    return NextResponse.json({ error: msg }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}