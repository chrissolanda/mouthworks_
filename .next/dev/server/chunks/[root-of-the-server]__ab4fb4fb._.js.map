{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/mouthworks_/app/api/inventory/create/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\n// Server-side route to create inventory using the service role key.\r\n// This route verifies the requester's access token and ensures they are a staff/hr user\r\n// before performing the insert with the service role key (bypassing RLS safely).\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // Prefer explicit server config. Fall back to NEXT_PUBLIC_SUPABASE_URL default if present.\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL || \"https://xpybqjfofdmkeiijvwnx.supabase.co\"\r\n\r\n    // Expect the client to forward the user's access token in Authorization header\r\n    // For dev/testing, allow requests without a token; in production require it\r\n    const authHeader = req.headers.get(\"authorization\") || \"\"\r\n    const token = authHeader.replace(/^Bearer\\s+/i, \"\")\r\n    console.log(\"[v0] API route received auth header:\", authHeader ? \"yes\" : \"no\")\r\n    console.log(\"[v0] Extracted token:\", token ? \"yes\" : \"no\")\r\n    \r\n    const isProduction = process.env.NODE_ENV === \"production\"\r\n    if (!token && isProduction) {\r\n      return NextResponse.json({ error: \"Missing Authorization token\" }, { status: 401 })\r\n    }\r\n\r\n    const body = await req.json()\r\n\r\n    // Service role must be provided in production. Allow a DEV-only fallback to anon key.\r\n    // WARNING: This is insecure and only intended to unblock local development/testing.\r\n    let serverKey = process.env.SUPABASE_SERVICE_ROLE || process.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE\r\n    if (!serverKey) {\r\n      if (process.env.NODE_ENV === \"production\") {\r\n        const hint = \"Set SUPABASE_SERVICE_ROLE env var (use your Supabase project's service_role key).\\nIn PowerShell: $env:SUPABASE_SERVICE_ROLE='your-key'\"\r\n        return NextResponse.json({ error: `Missing SUPABASE_SERVICE_ROLE. ${hint}` }, { status: 500 })\r\n      } else {\r\n        serverKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n        console.warn(\r\n          \"[v0] SUPABASE_SERVICE_ROLE not set â€” falling back to NEXT_PUBLIC_SUPABASE_ANON_KEY for local development (insecure).\"\r\n        )\r\n      }\r\n    }\r\n\r\n    if (!serverKey) {\r\n      const hint =\r\n        \"Set SUPABASE_SERVICE_ROLE env var (use your Supabase project's service_role key).\\nIn PowerShell: $env:SUPABASE_SERVICE_ROLE='your-key'\"\r\n      return NextResponse.json({ error: `Missing SUPABASE_SERVICE_ROLE. ${hint}` }, { status: 500 })\r\n    }\r\n\r\n    // Only set Authorization header if we have a token\r\n    const clientConfig: any = {}\r\n    if (token) {\r\n      clientConfig.global = {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      }\r\n    }\r\n    const supabase = createClient(supabaseUrl, serverKey, clientConfig)\r\n\r\n    // Verify token and fetch the user (if token is present)\r\n    let userId: string | null = null\r\n    if (token) {\r\n      const { data: userRes, error: userErr } = await supabase.auth.getUser(token as any)\r\n      if (userErr || !userRes?.user) {\r\n        return NextResponse.json({ error: \"Invalid or expired token\" }, { status: 401 })\r\n      }\r\n      userId = userRes.user.id\r\n    } else {\r\n      // DEV: allow token-less requests; just proceed without user verification\r\n      console.warn(\"[v0] No token provided; skipping user verification (dev mode)\")\r\n    }\r\n\r\n    // Check staff table if we have a user ID (optional in dev)\r\n    if (userId) {\r\n      const { data: staffRow, error: staffErr } = await supabase\r\n        .from(\"staff\")\r\n        .select(\"id, role, user_id\")\r\n        .eq(\"user_id\", userId)\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      if (staffErr) {\r\n        return NextResponse.json({ error: staffErr.message || String(staffErr) }, { status: 500 })\r\n      }\r\n\r\n      if (!staffRow || (staffRow.role && staffRow.role !== \"hr\" && staffRow.role !== \"staff\")) {\r\n        return NextResponse.json({ error: \"Forbidden: not a staff member\" }, { status: 403 })\r\n      }\r\n    } else {\r\n      console.warn(\"[v0] No user ID; skipping staff verification (dev mode)\")\r\n    }\r\n\r\n    // simple snake_case conversion for known fields\r\n    const payload: any = {}\r\n    Object.entries(body || {}).forEach(([k, v]) => {\r\n      const snake = k.replace(/[A-Z]/g, (m) => `_${m.toLowerCase()}`)\r\n      payload[snake] = v\r\n    })\r\n\r\n    // Ensure required defaults\r\n    if (typeof payload.quantity === \"undefined\") payload.quantity = 0\r\n    if (typeof payload.min_quantity === \"undefined\") payload.min_quantity = 0\r\n    if (!payload.status) payload.status = \"ok\"\r\n\r\n    const { data, error } = await supabase.from(\"inventory\").insert([payload]).select().single()\r\n    if (error) {\r\n      return NextResponse.json({ error: error.message || String(error) }, { status: 500 })\r\n    }\r\n\r\n    return NextResponse.json(data)\r\n  } catch (err) {\r\n    const msg = err instanceof Error ? err.message : String(err)\r\n    return NextResponse.json({ error: msg }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}