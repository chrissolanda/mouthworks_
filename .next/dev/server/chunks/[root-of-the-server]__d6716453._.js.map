{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/mouthworks_/app/api/auth/register/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"https://xpybqjfofdmkeiijvwnx.supabase.co\"\r\n\r\n    const body = await req.json()\r\n    const { email, password, name, phone } = body\r\n\r\n    if (!email || !password || !name) {\r\n      return NextResponse.json({ error: \"Email, password, and name are required\" }, { status: 400 })\r\n    }\r\n\r\n    // Use service role for server-side registration; fall back to anon key for demos\r\n    const serverKey =\r\n      process.env.SUPABASE_SERVICE_ROLE ||\r\n      process.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE ||\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n    if (!serverKey) {\r\n      return NextResponse.json(\r\n        { error: \"Server configuration error: SUPABASE_SERVICE_ROLE not set\" },\r\n        { status: 500 },\r\n      )\r\n    }\r\n\r\n    const supabase = createClient(supabaseUrl, serverKey, {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n      }\r\n    })\r\n\r\n    // Check if user already exists\r\n    const { data: existing, error: getErr } = await supabase\r\n      .from(\"auth_users\")\r\n      .select(\"*\")\r\n      .eq(\"email\", email)\r\n      .maybeSingle()\r\n\r\n    if (getErr) {\r\n      console.error(\"[v0] Error checking existing auth user:\", getErr)\r\n      return NextResponse.json({ error: \"Registration failed\" }, { status: 500 })\r\n    }\r\n\r\n    if (existing) {\r\n      return NextResponse.json({ status: \"exists\", user: existing }, { status: 409 })\r\n    }\r\n\r\n    // Create auth_users entry\r\n    const { data: createdAuth, error: insertErr } = await supabase\r\n      .from(\"auth_users\")\r\n      .insert([\r\n        { email, password_hash: password, name, role: \"patient\", phone: phone || null },\r\n      ])\r\n      .select()\r\n      .single()\r\n\r\n    if (insertErr || !createdAuth) {\r\n      console.error(\"[v0] Error creating auth user:\", insertErr)\r\n      return NextResponse.json({ error: \"Registration failed\" }, { status: 500 })\r\n    }\r\n\r\n    // Create patients row\r\n    const { data: patientRow, error: patientErr } = await supabase\r\n      .from(\"patients\")\r\n      .insert([\r\n        { user_id: createdAuth.id, name, email, phone: phone || null },\r\n      ])\r\n      .select()\r\n      .single()\r\n\r\n    if (patientErr) {\r\n      console.warn(\"[v0] Warning creating patient row:\", patientErr)\r\n    }\r\n\r\n    return NextResponse.json({\r\n      status: \"created\",\r\n      user: {\r\n        id: createdAuth.id,\r\n        email: createdAuth.email,\r\n        name: createdAuth.name,\r\n        role: \"patient\",\r\n        phone: createdAuth.phone,\r\n      }\r\n    })\r\n  } catch (err) {\r\n    const msg = err instanceof Error ? err.message : String(err)\r\n    console.error(\"[v0] Registration API error:\", msg)\r\n    return NextResponse.json({ error: msg }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,cAAc,gFAAwC;QAE5D,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QAEzC,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,MAAM;YAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyC,GAAG;gBAAE,QAAQ;YAAI;QAC9F;QAEA,iFAAiF;QACjF,MAAM,YACJ,QAAQ,GAAG,CAAC,qBAAqB,IACjC,QAAQ,GAAG,CAAC,iCAAiC;QAG/C;;QAOA,MAAM,WAAW,IAAA,yMAAY,EAAC,aAAa,WAAW;YACpD,MAAM;gBACJ,kBAAkB;gBAClB,gBAAgB;YAClB;QACF;QAEA,+BAA+B;QAC/B,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,SAC7C,IAAI,CAAC,cACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAS,OACZ,WAAW;QAEd,IAAI,QAAQ;YACV,QAAQ,KAAK,CAAC,2CAA2C;YACzD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,IAAI,UAAU;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;gBAAU,MAAM;YAAS,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,0BAA0B;QAC1B,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SACnD,IAAI,CAAC,cACL,MAAM,CAAC;YACN;gBAAE;gBAAO,eAAe;gBAAU;gBAAM,MAAM;gBAAW,OAAO,SAAS;YAAK;SAC/E,EACA,MAAM,GACN,MAAM;QAET,IAAI,aAAa,CAAC,aAAa;YAC7B,QAAQ,KAAK,CAAC,kCAAkC;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,sBAAsB;QACtB,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACnD,IAAI,CAAC,YACL,MAAM,CAAC;YACN;gBAAE,SAAS,YAAY,EAAE;gBAAE;gBAAM;gBAAO,OAAO,SAAS;YAAK;SAC9D,EACA,MAAM,GACN,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,IAAI,CAAC,sCAAsC;QACrD;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,QAAQ;YACR,MAAM;gBACJ,IAAI,YAAY,EAAE;gBAClB,OAAO,YAAY,KAAK;gBACxB,MAAM,YAAY,IAAI;gBACtB,MAAM;gBACN,OAAO,YAAY,KAAK;YAC1B;QACF;IACF,EAAE,OAAO,KAAK;QACZ,MAAM,MAAM,eAAe,QAAQ,IAAI,OAAO,GAAG,OAAO;QACxD,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAI,GAAG;YAAE,QAAQ;QAAI;IACzD;AACF"}}]
}